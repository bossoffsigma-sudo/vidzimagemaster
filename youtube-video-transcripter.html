<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YouTube Transcripter</title>
<style>
  :root{
    --blue:#0b84ff;
    --bg:#ffffff;
    --muted:#6b7280;
    --card-shadow: 0 8px 24px rgba(10,20,40,0.06);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#f7fbff,#ffffff);color:#0b1b2b}
  .wrap{max-width:980px;margin:28px auto;padding:18px;}
  header{display:flex;gap:12px;align-items:center;margin-bottom:14px}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--blue),#0a6fe0);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px;box-shadow:var(--card-shadow)}
  h1{margin:0;font-size:20px}
  p.lead{margin:0;color:var(--muted);font-size:13px}

  .card{background:var(--bg);border-radius:12px;padding:14px;box-shadow:var(--card-shadow);margin-bottom:14px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type=text], select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e9f2ff;background:#fbfeff;font-size:14px;box-sizing:border-box}
  .row{display:flex;gap:8px;align-items:center}
  .row.col{flex-direction:column;align-items:stretch}
  button{background:var(--blue);color:#fff;padding:10px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
  button.ghost{background:transparent;border:1px solid #e6f0ff;color:var(--blue)}
  .muted{color:var(--muted);font-size:13px}
  .transcript{min-height:300px;border-radius:8px;border:1px solid #eef6ff;padding:10px;background:#fbfeff;overflow:auto;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;font-size:13px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  @media (max-width:700px){ .row{flex-direction:column} }
  footer{margin-top:8px;color:var(--muted);font-size:13px;text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">YT</div>
      <div>
        <h1>YouTube Transcripter</h1>
        <p class="lead">Paste YouTube URL or Video ID, choose language (optional) and fetch transcript. Use proxy option if direct fetch fails.</p>
      </div>
    </header>

    <div class="card">
      <label for="videoInput">YouTube URL or Video ID</label>
      <div class="row">
        <input id="videoInput" type="text" placeholder="https://www.youtube.com/watch?v=VIDEO_ID or youtu.be/VIDEO_ID or VIDEO_ID" />
        <button id="fetchBtn">Fetch Transcript</button>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <div style="flex:1">
          <label for="langInput">Language (optional, use language code e.g. en, hi, es)</label>
          <input id="langInput" type="text" placeholder="leave empty for auto / best-effort" />
        </div>
        <div style="width:150px">
          <label for="maxLines">Max lines</label>
          <select id="maxLines">
            <option value="0">Full</option>
            <option value="200">200</option>
            <option value="100">100</option>
            <option value="30">30</option>
          </select>
        </div>
      </div>

      <div style="height:10px"></div>

      <div>
        <label for="proxyBase">Proxy Base URL (optional)</label>
        <input id="proxyBase" type="text" placeholder="e.g. https://your-proxy.example (leave empty to try direct fetch)" />
      </div>

      <div style="height:10px"></div>

      <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Transcript</strong>
        <div class="controls">
          <button id="copyBtn" class="ghost">Copy</button>
          <button id="downloadBtn" class="ghost">Download .txt</button>
          <button id="clearBtn" class="ghost">Clear</button>
        </div>
      </div>

      <div id="status" class="muted">Status: idle</div>
      <div style="height:8px"></div>

      <div id="output" class="transcript" contenteditable="true" aria-label="Transcript output">Paste a YouTube link above and click "Fetch Transcript".</div>

      <div style="height:8px"></div>

      <div class="muted">Notes: If the browser blocks direct requests due to CORS, deploy the optional server proxy and enter its base URL above.</div>
    </div>

    <footer>Â© YouTube Transcripter</footer>
  </div>

<script>
/* Utility functions and transcript fetching logic (no external libs) */

/* DOM refs */
const videoInput = document.getElementById('videoInput');
const fetchBtn = document.getElementById('fetchBtn');
const langInput = document.getElementById('langInput');
const maxLines = document.getElementById('maxLines');
const proxyBase = document.getElementById('proxyBase');
const output = document.getElementById('output');
const statusEl = document.getElementById('status');
const copyBtn = document.getElementById('copyBtn');
const downloadBtn = document.getElementById('downloadBtn');
const clearBtn = document.getElementById('clearBtn');

function setStatus(t){ statusEl.textContent = 'Status: ' + t; }

/* Extract video id from many URL patterns or accept raw 11-char id */
function extractVideoId(input){
  if(!input) return null;
  const s = input.trim();
  if(/^[a-zA-Z0-9_-]{11}$/.test(s)) return s;
  try{
    const url = new URL(s);
    // youtube.com/watch?v=...
    if(url.hostname.includes('youtube.com')){
      if(url.searchParams.has('v')) {
        const v = url.searchParams.get('v');
        if(/^[a-zA-Z0-9_-]{11}$/.test(v)) return v;
      }
      // path segments: /embed/VIDEO_ID or /v/VIDEO_ID
      const m = url.pathname.match(/(?:\/embed\/|\/v\/)([a-zA-Z0-9_-]{11})/);
      if(m && m[1]) return m[1];
    }
    // youtu.be short link
    if(url.hostname === 'youtu.be'){
      const m = url.pathname.match(/\/([a-zA-Z0-9_-]{11})/);
      if(m && m[1]) return m[1];
    }
  }catch(e){
    // not a valid URL, try patterns
  }
  // regex fallback: look for 11-char id in string
  const r = s.match(/([a-zA-Z0-9_-]{11})/);
  return r ? r[1] : null;
}

/* Convert timedtext XML to readable text w/ timestamps */
function xmlToText(xml){
  try{
    const parser = new DOMParser();
    const doc = parser.parseFromString(xml, 'text/xml');
    const nodes = Array.from(doc.getElementsByTagName('text'));
    if(nodes.length === 0) return xml.replace(/<\/?[^>]+(>|$)/g, '');
    const out = nodes.map(n=>{
      const start = n.getAttribute('start') || '';
      const dur = n.getAttribute('dur') || '';
      const text = (n.textContent || '').replace(/&amp;/g,'&').replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&gt;/g,'>').replace(/&lt;/g,'<');
      const ts = start ? '[' + prettyTime(parseFloat(start)) + ']' : '';
      return ts + ' ' + text;
    });
    return out.join('\n\n');
  }catch(e){
    return xml.replace(/<\/?[^>]+(>|$)/g, '');
  }
}

function prettyTime(sec){
  if(!sec || isNaN(sec)) return '0:00';
  const s = Math.floor(sec % 60).toString().padStart(2,'0');
  const m = Math.floor((sec/60)%60);
  const h = Math.floor(sec/3600);
  return (h>0 ? h+':' : '') + m + ':' + s;
}

/* Heuristic to extract visible text from HTML response (fallback) */
function squashText(html){
  let s = html.replace(/<script[\s\S]*?<\/script>/gi,'');
  s = s.replace(/<\/?[^>]+(>|$)/g, ' ');
  s = s.replace(/\s{2,}/g,' ').trim();
  const parts = s.split(/(?<=\.)\s+(?=[A-Z0-9])/).slice(0,200);
  return parts.join('\n\n');
}

/* Main fetch strategy */
async function fetchTranscript(){
  const raw = videoInput.value.trim();
  const id = extractVideoId(raw);
  if(!id){
    alert('Please supply a valid YouTube URL or Video ID.');
    return;
  }
  const lang = (langInput.value || '').trim();
  const max = parseInt(maxLines.value,10) || 0;
  output.textContent = '';
  setStatus('starting fetch for ' + id);
  fetchBtn.disabled = true;

  const proxy = (proxyBase.value || '').trim();

  try{
    if(proxy){
      setStatus('using proxy: ' + proxy);
      const url = new URL(`${proxy.replace(/\/$/,'')}/transcript/${id}`);
      if(lang) url.searchParams.set('lang', lang);
      const r = await fetch(url.toString());
      if(!r.ok) throw new Error('proxy fetch failed: ' + r.status);
      const text = await r.text();
      presentText(text, max);
      setStatus('fetched via proxy');
      return;
    }

    // Try official timedtext endpoint (may be blocked by CORS)
    try{
      const timed = `https://video.google.com/timedtext?v=${id}` + (lang ? `&lang=${encodeURIComponent(lang)}` : '');
      const r = await fetch(timed, { mode:'cors' });
      if(r.ok){
        const text = await r.text();
        if(text && text.trim()){
          const pretty = xmlToText(text);
          presentText(pretty, max);
          setStatus('fetched timedtext (direct)');
          return;
        }
      }
    }catch(e){
      console.warn('timedtext failed', e && e.message);
    }

    // Try jina.ai page proxy (best-effort)
    try{
      const r2 = await fetch(`https://r.jina.ai/http://www.youtube.com/watch?v=${id}`, { mode:'cors' });
      if(r2.ok){
        const body = await r2.text();
        if(body && body.length > 200){
          presentText(squashText(body), max);
          setStatus('fetched via jina.ai (best-effort)');
          return;
        }
      }
    }catch(e){
      console.warn('jina.ai failed', e && e.message);
    }

    // Try list of captions
    try{
      const listUrl = `https://video.google.com/timedtext?type=list&v=${id}`;
      const r3 = await fetch(listUrl, { mode:'cors' });
      if(r3.ok){
        const body = await r3.text();
        if(body && body.trim()){
          presentText('Available captions (xml):\n\n' + body, max);
          setStatus('fetched captions list');
          return;
        }
      }
    }catch(e){
      console.warn('list fetch failed', e && e.message);
    }

    throw new Error('All direct attempts failed (CORS or captions not available). Deploy server proxy and set Proxy Base URL.');
  }catch(err){
    output.textContent = 'Error: ' + (err.message || String(err));
    setStatus('failed');
    console.error(err);
  }finally{
    fetchBtn.disabled = false;
  }
}

function presentText(txt, max){
  let cleaned = (txt || '').replace(/\r/g,'').trim();
  if(!cleaned) cleaned = '[no transcript returned]';
  const xmlLike = cleaned.startsWith('<') && cleaned.indexOf('text') !== -1;
  if(xmlLike && cleaned.indexOf('<text') !== -1){
    cleaned = xmlToText(cleaned);
  }
  let lines = cleaned.split(/\n{1,}/).map(s=>s.trim()).filter(Boolean);
  const maxN = parseInt(max,10) || 0;
  if(maxN>0) lines = lines.slice(0, maxN);
  output.textContent = lines.join('\n\n');
}

/* Event bindings */
fetchBtn.addEventListener('click', fetchTranscript);
videoInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') fetchBtn.click(); });
copyBtn.addEventListener('click', ()=>{ navigator.clipboard.writeText(output.textContent).then(()=>alert('Copied to clipboard')).catch(()=>alert('Copy failed')); });
downloadBtn.addEventListener('click', ()=>{
  const data = output.textContent || '';
  const blob = new Blob([data], { type:'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'transcript.txt';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});
clearBtn.addEventListener('click', ()=>{ output.textContent = ''; setStatus('cleared'); });

setStatus('idle');
</script>
</body>
</html>
